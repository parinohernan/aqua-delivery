---
---
<div id="informesSection" class="section-content" style="display: none;">
  <div class="informes-section">
    <div class="informes-header">
      <div class="header-content">
        <h2 class="section-title">
          <span class="icon">ðŸ“Š</span>
          Informes y EstadÃ­sticas
        </h2>
        <p class="section-subtitle">Analiza el rendimiento de tu negocio</p>
      </div>
    </div>

    <div class="informes-container">
      <div class="filters-panel">
        <div class="filters-content">
          <div class="filter-group">
            <label class="filter-label">Fecha Desde</label>
            <input type="date" id="fechaDesde" class="filter-input">
          </div>
          
          <div class="filter-group">
            <label class="filter-label">Fecha Hasta</label>
            <input type="date" id="fechaHasta" class="filter-input">
          </div>
          
          <div class="filter-group">
            <label class="filter-label">Tipo de Informe</label>
            <select id="tipoInforme" class="filter-select">
              <option value="resumen">Resumen General</option>
              <option value="detallado">Detalle por Cliente</option>
            </select>
          </div>
          
          <button onclick="window.generarInforme()" class="btn-create">
            Generar Informe
          </button>
        </div>
      </div>

      <div id="informeResultados" class="informe-resultados">
        <div class="empty-state">
          <div class="empty-icon">ðŸ“Š</div>
          <h4>Genera tu primer informe</h4>
          <p>Selecciona un rango de fechas y el tipo de informe para comenzar</p>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  window.initInformesSection = function() {
    console.log('ðŸ“Š Inicializando secciÃ³n de informes...');
    // Set default dates
    const today = new Date().toISOString().split('T')[0];
    const firstDay = new Date();
    firstDay.setDate(1);
    const firstDayStr = firstDay.toISOString().split('T')[0];
    
    const fDesde = document.getElementById('fechaDesde');
    const fHasta = document.getElementById('fechaHasta');
    
    if (fDesde && !fDesde.value) fDesde.value = firstDayStr;
    if (fHasta && !fHasta.value) fHasta.value = today;
  };

  window.generarInforme = async function() {
    const fechaDesde = document.getElementById('fechaDesde')?.value;
    const fechaHasta = document.getElementById('fechaHasta')?.value;
    const tipoInforme = document.getElementById('tipoInforme')?.value;
    const resultadosDiv = document.getElementById('informeResultados');

    if (!fechaDesde || !fechaHasta) {
      alert('Selecciona ambas fechas');
      return;
    }

    try {
      resultadosDiv.innerHTML = '<div class="loading-state"><div class="spinner"></div><p>Generando...</p></div>';
      
      const token = localStorage.getItem('token');
      const apiUrl = window.API_CONFIG?.BASE_URL || 'http://localhost:8001';
      const response = await fetch(`${apiUrl}/api/informes/ventas?fechaDesde=${fechaDesde}&fechaHasta=${fechaHasta}&tipo=${tipoInforme}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });

      if (!response.ok) throw new Error('Error generando informe');

      const datos = await response.json();
      
      if (tipoInforme === 'resumen') {
        mostrarResumen(datos, resultadosDiv);
      } else {
        mostrarDetalle(datos, resultadosDiv);
      }
      
    } catch (error) {
      resultadosDiv.innerHTML = `<div class="error-state"><p>${error.message}</p></div>`;
    }
  };

  function mostrarResumen(datos, container) {
    container.innerHTML = `
      <div class="informe-card">
        <h4>ðŸ“ˆ Resumen de Ventas</h4>
        <div class="resumen-stats">
          <div class="stat-item">
            <div class="stat-value">${datos.totalPedidos || 0}</div>
            <div class="stat-label">Pedidos</div>
          </div>
          <div class="stat-item">
            <div class="stat-value">$${(datos.totalVentas || 0).toLocaleString('es-AR')}</div>
            <div class="stat-label">Ventas</div>
          </div>
        </div>
      </div>
    `;
  }

  function mostrarDetalle(datos, container) {
    const clientes = datos.clientes || [];
    
    if (clientes.length === 0) {
      container.innerHTML = `
        <div class="informe-card">
          <h4>ðŸ“‹ Detalle por Cliente</h4>
          <div class="empty-state-mini">
            <p>No se encontraron clientes con pedidos en el perÃ­odo seleccionado.</p>
          </div>
        </div>
      `;
      return;
    }

    let clientesHTML = '';
    
    clientes.forEach(cliente => {
      const nombreCompleto = `${cliente.nombre || ''} ${cliente.apellido || ''}`.trim() || 'Cliente sin nombre';
      const productosHTML = cliente.productos && cliente.productos.length > 0
        ? cliente.productos.map(prod => `
            <tr>
              <td>${prod.descripcion || 'Producto sin nombre'}</td>
              <td style="text-align: center;">${prod.cantidadTotal || 0}</td>
              <td style="text-align: right;">$${(prod.precioPromedio || 0).toFixed(2)}</td>
              <td style="text-align: right; color: #4ade80; font-weight: 600;">$${(prod.totalPagado || 0).toFixed(2)}</td>
            </tr>
          `).join('')
        : '<tr><td colspan="4" class="empty-state-mini">No hay productos registrados</td></tr>';

      const pedidosHTML = cliente.pedidos && cliente.pedidos.length > 0
        ? cliente.pedidos.map(pedido => {
            const fecha = pedido.fechaEntrega ? new Date(pedido.fechaEntrega).toLocaleDateString('es-AR') : 'Sin fecha';
            return `
              <div class="pedido-item">
                <div>
                  <div class="pedido-codigo">Pedido #${pedido.codigo || 'N/A'}</div>
                  <div class="pedido-fecha">ðŸ“… ${fecha}</div>
                </div>
                <div style="display: flex; gap: 1rem; align-items: center;">
                  <div class="pedido-items">ðŸ“¦ ${pedido.cantidadItems || 0} items</div>
                  <div class="pedido-total">$${(pedido.total || 0).toFixed(2)}</div>
                </div>
              </div>
            `;
          }).join('')
        : '<div class="empty-state-mini">No hay pedidos registrados</div>';

      clientesHTML += `
        <div class="cliente-card">
          <div class="cliente-header">
            <div class="cliente-info">
              <h5>${nombreCompleto}</h5>
              <p class="cliente-telefono">ðŸ“ž ${cliente.telefono || 'Sin telÃ©fono'}</p>
            </div>
            <div class="cliente-stats">
              <div class="stat-mini">
                <span class="stat-value">${cliente.totalPedidos || 0}</span>
                <span class="stat-label">Pedidos</span>
              </div>
              <div class="stat-mini">
                <span class="stat-value" style="color: #4ade80;">$${(cliente.totalComprado || 0).toFixed(2)}</span>
                <span class="stat-label">Total</span>
              </div>
            </div>
          </div>

          <div class="productos-cliente">
            <h6>ðŸ›’ Productos Comprados</h6>
            <table class="mini-table">
              <thead>
                <tr>
                  <th>Producto</th>
                  <th style="text-align: center;">Cantidad</th>
                  <th style="text-align: right;">Precio Prom.</th>
                  <th style="text-align: right;">Total</th>
                </tr>
              </thead>
              <tbody>
                ${productosHTML}
              </tbody>
            </table>
          </div>

          <div class="pedidos-cliente">
            <h6>ðŸ“‹ Pedidos</h6>
            <div class="pedidos-list">
              ${pedidosHTML}
            </div>
          </div>
        </div>
      `;
    });

    container.innerHTML = `
      <div class="informe-card">
        <h4>ðŸ“‹ Detalle por Cliente</h4>
        <p style="margin-bottom: 1.5rem; opacity: 0.9;">Se encontraron ${clientes.length} cliente${clientes.length !== 1 ? 's' : ''} en el perÃ­odo.</p>
        <div class="clientes-detalle">
          ${clientesHTML}
        </div>
      </div>
    `;
  }
</script>
