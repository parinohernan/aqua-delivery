---
---
<div id="pedidosSection" class="section-content" style="display: none;">
  <div class="pedidos-section">
    <!-- Header de la secci√≥n -->
    <div class="pedidos-header">
      <div class="header-content">
        <h1 class="section-title">
          <span class="icon">üì¶</span>
          Pedidos
        </h1>
      </div>
    </div>

    <!-- Contenedor principal -->
    <div class="pedidos-container">
      <!-- Panel de acciones -->
      <div class="actions-panel">
        <div class="actions-header">
          <h3>üéØ Acciones R√°pidas</h3>
        </div>
        <div class="actions-content">
          <!-- Campo de b√∫squeda -->
          <div class="search-group">
            <div class="search-input-wrapper">
              <span class="search-icon">üîç</span>
              <input 
                type="text" 
                id="pedidoClienteFilter" 
                class="search-input"
                placeholder="Buscar cliente..."
              />
            </div>
          </div>

          <div class="action-buttons">
            <button onclick="window.showCreateOrderModal()" class="btn-create">
              ‚ûï Nuevo Pedido
            </button>

            <button onclick="window.showDeliveryMap()" class="btn-export">
              üó∫Ô∏è Mapa de Entregas
            </button>
          </div>
        </div>
      </div>

      <!-- Panel de Tracking GPS -->
      <div class="tracking-panel">
        <div class="tracking-header">
          <h3>üìç Tracking GPS de Entregas</h3>
        </div>
        <div class="tracking-content">
          <!-- Bot√≥n principal de tracking -->
          <button id="toggleTrackingBtn" class="btn-tracking" onclick="window.toggleTracking()">
            <span class="tracking-icon">üìç</span>
            <span class="tracking-text">Iniciar Tracking GPS</span>
          </button>

          <div class="tracking-controls">
            <!-- Configuraci√≥n de distancia -->
            <div class="distance-config">
              <label for="proximityDistance" class="distance-label">Distancia de alerta:</label>
              <select id="proximityDistance" class="distance-select" onchange="window.updateProximityDistance(this.value)">
                <option value="300">300 metros</option>
                <option value="500" selected>500 metros</option>
                <option value="1000">1 kil√≥metro</option>
                <option value="2000">2 kil√≥metros</option>
              </select>
            </div>

            <!-- B√∫squeda manual de pedidos cercanos -->
            <button id="findNearestBtn" class="btn-find-nearest" onclick="window.findNearestDeliveries()">
              <span class="btn-icon">üéØ</span>
              <span class="btn-text">Encontrar M√°s Cercanos</span>
            </button>
          </div>

          <!-- Estado del tracking -->
          <div id="trackingStatus" class="tracking-status hidden">
            <div class="status-indicator active"></div>
            <span>Tracking activo - Calculando...</span>
          </div>
        </div>
      </div>

      <!-- Bot√≥n para mostrar/ocultar filtros -->
      <div class="filters-toggle">
        <button onclick="toggleAdvancedFilters()" class="btn-toggle-filters" id="toggleFiltersBtn">
          ‚ñº Mostrar Filtros
        </button>
      </div>

      <!-- Panel de filtros (oculto por defecto) -->
      <div class="filters-panel" id="advancedFiltersPanel" style="display: none;">
        <div class="filters-header">
          <h3>üîç Filtros Avanzados</h3>
        </div>
        <div class="filters-content">
          <div class="filter-group">
            <label class="filter-label">Estado del Pedido</label>
            <select id="pedidoEstadoFilter" class="filter-select">
              <option value="">Todos los estados</option>
              <option value="pendient" selected>üì¶ Pendientes</option>
              <option value="proceso">üîÑ En Proceso</option>
              <option value="entregad">‚úÖ Entregados</option>
              <option value="anulado">‚ùå Anulados</option>
            </select>
          </div>
          
          <div class="filter-group">
            <label class="filter-label">Fecha de Entrega</label>
            <input 
              type="date" 
              id="pedidoFechaFilter" 
              class="filter-input"
              placeholder="Seleccionar fecha..."
            />
          </div>
          
          <div class="filter-group">
            <label class="filter-label">Zona de Entrega</label>
            <select id="pedidoZonaFilter" class="filter-select">
              <option value="">Todas las zonas</option>
            </select>
          </div>
        </div>
        
        <div class="filter-actions">
          <button onclick="applyPedidoFilters()" class="btn-filter">
            üîç Aplicar Filtros
          </button>
          <button onclick="clearPedidoFilters()" class="btn-clear-filters">
            üóëÔ∏è Limpiar Filtros
          </button>
        </div>
      </div>

      <!-- Contador de pedidos -->
      <div class="pedidos-counter">
        <div class="counter-content">
          <span class="counter-label">üìä Pedidos Encontrados</span>
          <span class="counter-value" id="pedidosCounter">Cargando...</span>
        </div>
      </div>

      <!-- Lista de pedidos -->
      <div class="pedidos-list">
        <div class="list-header">
          <h3>üìã Lista de Pedidos</h3>
        </div>
        <div class="pedidos-grid" id="pedidosGrid">
          <div class="loading-state">
            <div class="loading-spinner"></div>
            <p>Cargando pedidos...</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Variables globales para pedidos
  let currentPedidoFilters = {
    estado: 'pendient',
    fecha: '',
    zona: '',
    search: ''
  };
  
  let allPedidos = [];
  let currentPedidos = [];
  let pedidosSearchTimeout;

  // Exponer variables globalmente
  window.allPedidos = allPedidos;
  window.currentPedidos = currentPedidos;

  // Funci√≥n principal para inicializar la secci√≥n
  window.initPedidosSection = async function() {
    console.log('üöÄ Inicializando secci√≥n de pedidos...');
    await loadPedidosData();
    setupPedidosEventListeners();
  };

  // Cargar datos de pedidos
  async function loadPedidosData() {
    console.log('üì¶ Cargando datos de pedidos...');
    const token = localStorage.getItem('token');

    try {
      // Cargar zonas primero si es necesario
      if (window.loadZonas) await window.loadZonas();
      
      const params = new URLSearchParams();
      // Aplicar filtros actuales
      Object.keys(currentPedidoFilters).forEach(key => {
        if (currentPedidoFilters[key] && currentPedidoFilters[key].trim() !== '') {
          params.append(key, currentPedidoFilters[key]);
        }
      });
      
      const apiUrl = window.API_CONFIG?.BASE_URL || 'http://localhost:8001';
      const response = await fetch(`${apiUrl}/api/pedidos?${params.toString()}`, {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });

      if (!response.ok) {
        throw new Error(`Error ${response.status}: ${await response.text()}`);
      }

      const pedidos = await response.json();
      console.log('‚úÖ Pedidos cargados:', pedidos.length);
      
      // Actualizar variables
      allPedidos = pedidos;
      currentPedidos = pedidos;
      window.allPedidos = pedidos;
      window.currentPedidos = pedidos;
      
      // Actualizar UI
      updatePedidosCounter(pedidos.length);
      renderPedidosGrid(pedidos);
      
    } catch (error) {
      console.error('‚ùå Error cargando pedidos:', error);
      showPedidosError(error);
    }
  }

  // Configurar event listeners
  function setupPedidosEventListeners() {
    console.log('üéß Configurando event listeners para pedidos...');
    
    const clienteFilter = document.getElementById('pedidoClienteFilter');
    if (clienteFilter) {
      // Remover listeners anteriores para evitar duplicados
      const newFilter = clienteFilter.cloneNode(true);
      clienteFilter.parentNode.replaceChild(newFilter, clienteFilter);
      
      newFilter.addEventListener('input', debounce(() => {
        applyPedidoFilters();
      }, 300));
    }
    
    // Configurar otros filtros...
    ['pedidoEstadoFilter', 'pedidoFechaFilter', 'pedidoZonaFilter'].forEach(id => {
      const el = document.getElementById(id);
      if (el) {
        el.addEventListener('change', () => applyPedidoFilters());
      }
    });

    // Escuchar eventos globales
    if (window.eventBus && window.EVENTS) {
      window.eventBus.on(window.EVENTS.PEDIDO_CREATED, () => {
        console.log('‚ú® Evento PEDIDO_CREATED recibido, recargando lista...');
        loadPedidosData();
      });
    }
  }

  // Aplicar filtros
  window.applyPedidoFilters = async function() {
    const estadoFilter = document.getElementById('pedidoEstadoFilter');
    const fechaFilter = document.getElementById('pedidoFechaFilter');
    const zonaFilter = document.getElementById('pedidoZonaFilter');
    const clienteFilter = document.getElementById('pedidoClienteFilter');
    
    currentPedidoFilters = {
      estado: estadoFilter ? estadoFilter.value : '',
      fecha: fechaFilter ? fechaFilter.value : '',
      zona: zonaFilter ? zonaFilter.value : '',
      search: clienteFilter ? clienteFilter.value : ''
    };
    
    console.log('üîç Aplicando filtros:', currentPedidoFilters);
    await loadPedidosData();
  };

  // Limpiar filtros
  window.clearPedidoFilters = function() {
    console.log('üóëÔ∏è Limpiando filtros de pedidos...');
    
    currentPedidoFilters = {
      estado: '',
      fecha: '',
      zona: '',
      search: ''
    };
    
    // Resetear inputs
    const inputs = ['pedidoEstadoFilter', 'pedidoFechaFilter', 'pedidoZonaFilter', 'pedidoClienteFilter'];
    inputs.forEach(id => {
      const el = document.getElementById(id);
      if (el) el.value = '';
    });
    
    loadPedidosData();
  };

  // Toggle filtros avanzados
  window.toggleAdvancedFilters = function() {
    const filtersPanel = document.getElementById('advancedFiltersPanel');
    const toggleBtn = document.getElementById('toggleFiltersBtn');
    
    if (!filtersPanel || !toggleBtn) return;
    
    const isHidden = filtersPanel.style.display === 'none' || !filtersPanel.style.display;
    
    if (isHidden) {
      filtersPanel.style.display = 'block';
      filtersPanel.style.maxHeight = '0px';
      filtersPanel.style.opacity = '0';
      filtersPanel.offsetHeight; // Force reflow
      filtersPanel.style.maxHeight = '1000px';
      filtersPanel.style.opacity = '1';
      toggleBtn.innerHTML = '‚ñ≤ Ocultar Filtros';
      toggleBtn.classList.add('active');
    } else {
      filtersPanel.style.maxHeight = '0px';
      filtersPanel.style.opacity = '0';
      setTimeout(() => {
        filtersPanel.style.display = 'none';
      }, 300);
      toggleBtn.innerHTML = '‚ñº Mostrar Filtros';
      toggleBtn.classList.remove('active');
    }
  };

  // Actualizar contador
  function updatePedidosCounter(count) {
    const counter = document.getElementById('pedidosCounter');
    if (counter) {
      counter.textContent = `${count} pedido${count !== 1 ? 's' : ''}`;
    }
  }

  // Renderizar grid
  function renderPedidosGrid(pedidos) {
    const grid = document.getElementById('pedidosGrid');
    if (!grid) return;

    if (pedidos.length === 0) {
      grid.innerHTML = `
        <div class="empty-state">
          <div class="empty-icon">üì¶</div>
          <h4>No se encontraron pedidos</h4>
          <p>No hay pedidos que coincidan con los filtros aplicados.</p>
        </div>
      `;
      return;
    }

    grid.innerHTML = pedidos.map(pedido => {
      // DEBUG: Ver estructura del pedido
      if (pedidos.indexOf(pedido) === 0) console.log('üîç Estructura del primer pedido:', pedido);
      
      const id = pedido.codigo || pedido.id;
      const nombreCompleto = (pedido.cliente_nombre || `${pedido.nombre || ''} ${pedido.apellido || ''}`).trim();
      const direccion = pedido.direccion || 'Sin direcci√≥n';
      const telefono = pedido.telefono || 'Sin tel√©fono';
      const total = parseFloat(pedido.total || 0).toFixed(2);
      
      // Formatear items para preview
      let itemsPreview = 'Sin productos';
      const items = pedido.productos || pedido.items || pedido.detalles || [];
      
      if (items.length > 0) {
        itemsPreview = items.map(p => 
          `${parseInt(p.cantidad)}x ${p.descripcion || p.nombre || p.nombreProducto || 'Producto'}`
        ).join(', ');
      }

      return `
        <div class="pedido-card">
          <div class="pedido-header">
            <span class="pedido-number">#${id}</span>
            <span class="pedido-status ${pedido.estado}">${getStatusText(pedido.estado)}</span>
          </div>
          
          <div class="pedido-body">
            <div class="client-info">
              <span class="client-name">${nombreCompleto || 'Cliente sin nombre'}</span>
              <div class="client-details">
                <span>üìç ${direccion}</span>
              </div>
              <div class="client-details">
                <span>üìû ${telefono}</span>
              </div>
            </div>
            
            <div class="items-preview">
              ${itemsPreview}
            </div>
          </div>
          
          <div class="pedido-footer">
            <div class="total-section">
              <span class="total-label">Total del pedido</span>
              <span class="total-amount">$${total}</span>
            </div>
            
            <div class="pedido-actions">
              ${pedido.estado === 'pendient' ? `
                <button onclick="startDelivery(${id})" class="btn-action btn-deliver">
                  üöö ENTREGAR
                </button>
                <button onclick="cancelPedido(${id})" class="btn-action btn-cancel">
                  ‚ùå ANULAR
                </button>
              ` : ''}
              
              ${pedido.estado === 'entregad' ? `
                <button class="btn-action btn-deliver" disabled style="opacity: 0.7; grid-column: span 2;">
                  ‚úÖ ENTREGADO
                </button>
              ` : ''}
              
              ${pedido.estado === 'anulado' ? `
                <button class="btn-action btn-cancel" disabled style="opacity: 0.7; grid-column: span 2;">
                  ‚ùå ANULADO
                </button>
              ` : ''}
              
              <button onclick="window.showOrderDetails(${id})" class="btn-action btn-view">
                üëÅÔ∏è VER DETALLES
              </button>
            </div>
          </div>
        </div>
      `;
    }).join('');
  }

  // Helpers de estado
  function getStatusText(estado) {
    switch (estado) {
      case 'pendient': return 'PENDIENTE';
      case 'proceso': return 'EN PROCESO';
      case 'entregad': return 'ENTREGADO';
      case 'anulado': return 'ANULADO';
      default: return 'DESCONOCIDO';
    }
  }

  function showPedidosError(error) {
    const grid = document.getElementById('pedidosGrid');
    if (grid) {
      grid.innerHTML = `
        <div class="empty-state">
          <div class="empty-icon">‚ùå</div>
          <h4>Error cargando pedidos</h4>
          <p>${error.message || 'Ocurri√≥ un error inesperado'}</p>
          <button onclick="loadPedidosData()" class="btn-create" style="margin-top: 1rem;">
            üîÑ Reintentar
          </button>
        </div>
      `;
    }
  }

  // Debounce helper
  function debounce(func, wait) {
    let timeout;
    return function(...args) {
      clearTimeout(timeout);
      timeout = setTimeout(() => func.apply(this, args), wait);
    };
  }

  // Acciones de pedido
  window.startDelivery = function(pedidoId) {
    console.log('üöö Iniciando entrega:', pedidoId);
    if (window.deliveryModal && typeof window.deliveryModal.show === 'function') {
      window.deliveryModal.show(pedidoId);
    } else {
      alert('Modal de entrega no disponible. Recarga la p√°gina.');
    }
  };

  window.cancelPedido = function(pedidoId) {
    if (confirm('¬øEst√°s seguro de que quieres cancelar este pedido?')) {
      updatePedidoStatus(pedidoId, 'anulado');
    }
  };

  window.showOrderDetails = function(pedidoId) {
    const pedido = window.allPedidos.find(p => (p.codigo || p.id) == pedidoId);
    if (pedido && window.orderModal) {
      // Por ahora usamos el modal de edici√≥n para ver detalles
      // Idealmente el modal deber√≠a tener un modo "solo lectura"
      window.orderModal.show(pedido);
    } else {
      console.error('Pedido no encontrado o modal no disponible');
    }
  };

  async function updatePedidoStatus(pedidoId, newStatus) {
    const token = localStorage.getItem('token');
    try {
      const apiUrl = window.API_CONFIG?.BASE_URL || 'http://localhost:8001';
      const response = await fetch(`${apiUrl}/api/pedidos/${pedidoId}/estado`, {
        method: 'PUT',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ estado: newStatus })
      });

      if (!response.ok) throw new Error(await response.text());

      if (newStatus === 'anulado') alert('‚úÖ Pedido cancelado correctamente');
      await loadPedidosData();
      
    } catch (error) {
      alert('Error actualizando el estado: ' + error.message);
    }
  }

  // Exponer funciones necesarias
  window.loadPedidosData = loadPedidosData;
  window.setupPedidosEventListeners = setupPedidosEventListeners;
</script>

<!-- M√≥dulos de Tracking GPS -->
<script src="/js/utils/GeolocationPermissions.js" is:inline></script>
<script src="/js/utils/GeoUtils.js" is:inline></script>
<script src="/js/delivery/ProximityTracker.js" is:inline></script>
<script src="/js/delivery/NearbyDeliveryFinder.js" is:inline></script>

<!-- Modal de Pedidos -->
<script src="/js/OrderModal.js" is:inline></script>
<!-- Modal de Entrega -->
<script src="/js/DeliveryModal.js" is:inline></script>

<script>
  // Funciones globales de control de tracking
  window.toggleTracking = async function() {
    if (!window.proximityTracker) {
      console.error('‚ùå ProximityTracker no disponible');
      return;
    }

    if (window.proximityTracker.isTracking) {
      window.proximityTracker.stopTracking();
    } else {
      await window.proximityTracker.startTracking();
    }
  };

  window.updateProximityDistance = function(distance) {
    if (!window.proximityTracker) {
      console.error('‚ùå ProximityTracker no disponible');
      return;
    }

    const meters = parseInt(distance);
    window.proximityTracker.setProximityThreshold(meters);
    
    if (window.showNotification) {
      window.showNotification(`Distancia de alerta actualizada: ${meters}m`, 'success');
    }
  };

  window.findNearestDeliveries = async function() {
    if (!window.nearbyDeliveryFinder) {
      console.error('‚ùå NearbyDeliveryFinder no disponible');
      return;
    }

    try {
      // Obtener distancia configurada
      const distanceSelect = document.getElementById('proximityDistance');
      const maxDistance = distanceSelect ? parseInt(distanceSelect.value) : null;
      
      await window.nearbyDeliveryFinder.findNearbyDeliveries(maxDistance);
    } catch (error) {
      console.error('‚ùå Error en b√∫squeda de pedidos cercanos:', error);
    }
  };

  console.log('‚úÖ Tracking GPS functions loaded');
</script>
