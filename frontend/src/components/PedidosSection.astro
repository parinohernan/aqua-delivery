---
// Componente para la gesti√≥n de pedidos
---

<div id="pedidosSection">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
    <h3 class="content-title" style="margin-bottom: 0;">Pedidos</h3>
    <button onclick="showCreatePedidoModal()" class="btn-primary" style="width: auto; padding: 0.5rem 1rem;">
      + Nuevo Pedido
    </button>
  </div>
  
  <div style="margin-bottom: 1.5rem;">
    <!-- Filtros principales -->
    <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap; margin-bottom: 1rem;">
      <div style="display: flex; align-items: center; gap: 0.5rem;">
        <label style="font-weight: 500; color: #374151; font-size: 0.875rem;">Estado:</label>
        <select id="filterEstado" onchange="filterPedidos()" class="form-input" style="width: auto; min-width: 140px;">
          <option value="">Todos los estados</option>
          <option value="pendient" selected>üì¶ Pendientes</option>
          <option value="proceso">üîÑ En Proceso</option>
          <option value="entregad">‚úÖ Entregados</option>
          <option value="anulado">‚ùå Anulados</option>
        </select>
      </div>
      
      <div style="display: flex; align-items: center; gap: 0.5rem;">
        <label style="font-weight: 500; color: #374151; font-size: 0.875rem;">Fecha:</label>
        <input 
          type="date" 
          id="filterFecha" 
          onchange="filterPedidos()" 
          class="form-input" 
          style="width: auto;"
        />
      </div>
      
      <div style="display: flex; align-items: center; gap: 0.5rem;">
        <label style="font-weight: 500; color: #374151; font-size: 0.875rem;">Cliente:</label>
        <input 
          type="text" 
          id="filterCliente" 
          placeholder="Buscar por cliente..."
          onkeyup="filterPedidos()" 
          class="form-input" 
          style="width: auto; min-width: 200px;"
        />
      </div>
      
      <button 
        onclick="clearPedidosFilters()" 
        class="btn-secondary" 
        style="padding: 0.5rem 1rem; font-size: 0.875rem;"
      >
        üóëÔ∏è Limpiar filtros
      </button>
    </div>
    
    <!-- Informaci√≥n de resultados -->
    <div id="pedidosInfo" style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: #f9fafb; border-radius: 0.375rem; font-size: 0.875rem; color: #6b7280;">
      <span id="pedidosCount">Cargando pedidos...</span>
      <span id="pedidosFilters">Filtros: Pendientes por defecto</span>
    </div>
  </div>
  
  <div id="pedidosList" style="display: grid; gap: 1rem;">
    <!-- Los pedidos se cargar√°n aqu√≠ din√°micamente -->
  </div>
</div>

<!-- Modal de detalle de pedido -->
<div id="pedidoDetailModal" class="hidden modal-overlay">
  <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
      <h4 class="modal-title" style="margin: 0;">Detalle de Pedido</h4>
      <button onclick="closePedidoDetailModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6b7280;">√ó</button>
    </div>
    <div id="pedidoDetailContent"></div>
    <div style="display: flex; justify-content: flex-end; margin-top: 1rem;">
      <button onclick="closePedidoDetailModal()" class="btn-secondary">Cerrar</button>
    </div>
  </div>
  
</div>

<script>
// Variables globales para pedidos
let currentPedidos: any[] = [];
let allPedidos: any[] = [];

// Cargar pedidos
async function loadPedidos() {
  console.log('üì¶ Cargando pedidos...');
  const token = localStorage.getItem('token');
  
  try {
    const response = await fetch('/api/pedidos', {
      headers: {
        'Authorization': `Bearer ${token}`
      }
    });
    
    if (!response.ok) {
      const errorText = await response.text();
      throw new Error(`Error ${response.status}: ${errorText}`);
    }
    
    const pedidos = await response.json();
    console.log('‚úÖ Pedidos cargados:', pedidos.length, 'pedidos');
    allPedidos = pedidos;
    
    // Aplicar filtro por defecto (pendientes)
    if (pedidos.length > 0) {
      // Configurar filtro por defecto
      const estadoSelect = document.getElementById('filterEstado') as HTMLSelectElement;
      if (estadoSelect) {
        estadoSelect.value = 'pendient';
      }
      
      // Aplicar filtros iniciales
      filterPedidos();
    } else {
      // No hay pedidos en absoluto - mostrar mensaje inicial
      const pedidosList = document.getElementById('pedidosList');
      if (pedidosList) {
        pedidosList.innerHTML = '<div style="text-align: center; padding: 2rem; color: #6b7280;">No hay pedidos registrados</div>';
      }
      
      // Actualizar informaci√≥n
      updatePedidosInfo([], '', '', '');
    }
  } catch (error) {
    console.error('üí• Error cargando pedidos:', error);
    const pedidosList = document.getElementById('pedidosList');
    if (pedidosList) {
      const errorMessage = error instanceof Error ? error.message : 'Error desconocido';
      pedidosList.innerHTML = '<div style="text-align: center; padding: 2rem; color: #dc2626;">Error cargando pedidos: ' + errorMessage + '</div>';
    }
  }
}

function renderPedidosList(pedidos) {
  const pedidosList = document.getElementById('pedidosList');
  if (!pedidosList) return;

  pedidosList.innerHTML = pedidos.map(pedido => {
    const id = pedido.id;
    const nombreCompleto = pedido.cliente_nombre || `${pedido.nombre || ''} ${pedido.apellido || ''}`.trim();
    const direccion = pedido.direccion || '';
    return `
      <div style="border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem; background: white;">
        <div style="display: flex; justify-content: space-between; align-items: start; gap: 1rem;">
          <div style="flex: 1;">
            <h4 style="font-weight: 700; color: #111827; margin: 0 0 0.25rem 0;">#${id}</h4>
            <p style="font-size: 0.95rem; color: #111827; margin: 0 0 0.25rem 0;">${nombreCompleto || 'Cliente'}</p>
            <p style="font-size: 0.875rem; color: #4b5563; margin: 0;">${direccion}</p>
          </div>
          <div style="display: flex; flex-direction: column; gap: 0.25rem; min-width: 220px; align-items: flex-end;">
            <button onclick="viewPedido(${id})" class="btn-small" style="background: #374151; color: white;">Ver detalle</button>
            <button onclick="cancelPedido(${id})" class="btn-small" style="background: #ef4444; color: white;">Anular</button>
            <button onclick="(window.startDelivery ? window.startDelivery(${id}) : (window.deliveryModal ? window.deliveryModal.show(${id}) : alert('Modal de entrega no disponible')))" class="btn-small" style="background: #10b981; color: white;">Entregar</button>
          </div>
        </div>
      </div>
    `;
  }).join('');
}

function getStatusColor(estado) {
  switch (estado) {
    case 'pendient':
      return 'background-color: #fef3c7; color: #92400e;';
    case 'proceso':
      return 'background-color: #dbeafe; color: #1e40af;';
    case 'entregad':
      return 'background-color: #d1fae5; color: #065f46;';
    case 'anulado':
      return 'background-color: #fee2e2; color: #991b1b;';
    default:
      return 'background-color: #f3f4f6; color: #374151;';
  }
}

function getStatusText(estado) {
  switch (estado) {
    case 'pendient':
      return 'Pendiente';
    case 'proceso':
      return 'En Proceso';
    case 'entregad':
      return 'Entregado';
    case 'anulado':
      return 'Anulado';
    default:
      return estado;
  }
}

// Filtrar pedidos
function filterPedidos() {
  const estadoFilter = (document.getElementById('filterEstado') as HTMLSelectElement)?.value || '';
  const fechaFilter = (document.getElementById('filterFecha') as HTMLInputElement)?.value || '';
  const clienteFilter = (document.getElementById('filterCliente') as HTMLInputElement)?.value || '';

  let filteredPedidos = allPedidos;

  if (estadoFilter) {
    filteredPedidos = filteredPedidos.filter((pedido: any) => pedido.estado === estadoFilter);
  }

  if (fechaFilter) {
    filteredPedidos = filteredPedidos.filter((pedido: any) => {
      const pedidoFecha = new Date(pedido.fecha_pedido).toISOString().split('T')[0];
      return pedidoFecha === fechaFilter;
    });
  }

  if (clienteFilter) {
    filteredPedidos = filteredPedidos.filter((pedido: any) => 
      pedido.cliente_nombre.toLowerCase().includes(clienteFilter.toLowerCase())
    );
  }

  currentPedidos = filteredPedidos;
  renderPedidosList(filteredPedidos);

  // Actualizar informaci√≥n de resultados
  updatePedidosInfo(filteredPedidos, estadoFilter, fechaFilter, clienteFilter);

  // Mostrar mensaje si no hay resultados pero mantener los filtros
  if (filteredPedidos.length === 0) {
    const container = document.getElementById('pedidosList');
    if (container) {
      container.innerHTML = `
        <div style="text-align: center; padding: 2rem; color: #6b7280;">
          <p style="font-size: 1.125rem; margin-bottom: 0.5rem;">No se encontraron pedidos</p>
          <p style="font-size: 0.875rem;">Intenta cambiar los filtros para ver m√°s resultados</p>
        </div>
      `;
    }
  }
}

// Actualizar informaci√≥n de resultados
function updatePedidosInfo(filteredPedidos, estadoFilter, fechaFilter, clienteFilter) {
  const pedidosCount = document.getElementById('pedidosCount');
  const pedidosFilters = document.getElementById('pedidosFilters');
  
  if (pedidosCount) {
    pedidosCount.textContent = `${filteredPedidos.length} pedido(s)`;
  }
  
  if (pedidosFilters) {
    const filters: string[] = [];
    if (estadoFilter) filters.push(`Estado: ${getStatusText(estadoFilter)}`);
    if (fechaFilter) filters.push(`Fecha: ${fechaFilter}`);
    if (clienteFilter) filters.push(`Cliente: "${clienteFilter}"`);
    
    const filterText = filters.length > 0 ? filters.join(', ') : 'Todos los pedidos';
    pedidosFilters.textContent = `Filtros: ${filterText}`;
  }
}

// Limpiar filtros
function clearPedidosFilters() {
  const estadoSelect = document.getElementById('filterEstado') as HTMLSelectElement;
  const fechaInput = document.getElementById('filterFecha') as HTMLInputElement;
  const clienteInput = document.getElementById('filterCliente') as HTMLInputElement;
  
  if (estadoSelect) estadoSelect.value = '';
  if (fechaInput) fechaInput.value = '';
  if (clienteInput) clienteInput.value = '';
  
  filterPedidos(); // Re-apply filters to show all
}

// Ver detalles del pedido
function viewPedido(pedidoId: number) {
  const pedido = currentPedidos.find((p: any) => p.id == pedidoId);
  if (!pedido) return;

  const modal = document.getElementById('pedidoDetailModal');
  const content = document.getElementById('pedidoDetailContent');
  if (!modal || !content) return;

  const nombre = pedido.cliente_nombre || `${pedido.nombre || ''} ${pedido.apellido || ''}`.trim();
  const fecha = new Date(pedido.fecha_pedido).toLocaleString();

  const items = (pedido.detalles || []).map((it: any) => `
    <tr>
      <td style="padding: 6px 8px; border-bottom: 1px solid #eee;">${it.descripcion || it.nombreProducto}</td>
      <td style="padding: 6px 8px; border-bottom: 1px solid #eee; text-align: right;">${it.cantidad}</td>
      <td style="padding: 6px 8px; border-bottom: 1px solid #eee; text-align: right;">$${parseFloat(it.precioUnitario || it.precio || 0).toFixed(2)}</td>
      <td style="padding: 6px 8px; border-bottom: 1px solid #eee; text-align: right;">$${parseFloat(it.subtotal || (it.cantidad * (it.precioUnitario || it.precio || 0))).toFixed(2)}</td>
    </tr>
  `).join('');

  content.innerHTML = `
    <div style="display:grid; gap: 8px;">
      <div><strong>Pedido:</strong> #${pedido.id}</div>
      <div><strong>Cliente:</strong> ${nombre}</div>
      <div><strong>Direcci√≥n:</strong> ${pedido.direccion || ''}</div>
      <div><strong>Tel√©fono:</strong> ${pedido.telefono || ''}</div>
      <div><strong>Fecha:</strong> ${fecha}</div>
      <div><strong>Estado:</strong> ${getStatusText(pedido.estado)}</div>
      <div><strong>Total:</strong> $${parseFloat(pedido.total).toFixed(2)}</div>
    </div>
    <div style="margin-top:12px;">
      <h5 style="margin: 0 0 6px 0;">Items</h5>
      <table style="width:100%; border-collapse: collapse; font-size: 0.9rem;">
        <thead>
          <tr>
            <th style="text-align:left; padding: 6px 8px; border-bottom: 1px solid #ddd;">Producto</th>
            <th style="text-align:right; padding: 6px 8px; border-bottom: 1px solid #ddd;">Cant.</th>
            <th style="text-align:right; padding: 6px 8px; border-bottom: 1px solid #ddd;">Precio</th>
            <th style="text-align:right; padding: 6px 8px; border-bottom: 1px solid #ddd;">Subtotal</th>
          </tr>
        </thead>
        <tbody>
          ${items || ''}
        </tbody>
      </table>
    </div>
  `;

  modal.classList.remove('hidden');
  modal.classList.add('show');
}

// Editar pedido
function editPedido(pedidoId: number) {
  alert('Funcionalidad de edici√≥n en desarrollo...');
}

// Crear nuevo pedido
function showCreatePedidoModal() {
  alert('Funcionalidad de creaci√≥n en desarrollo...');
}

function closePedidoDetailModal() {
  const modal = document.getElementById('pedidoDetailModal');
  if (modal) {
    modal.classList.remove('show');
    modal.classList.add('hidden');
  }
}

async function cancelPedido(pedidoId: number) {
  if (!confirm('¬øSeguro que quieres anular este pedido?')) return;
  try {
    const token = localStorage.getItem('token');
    const res = await fetch(`/api/pedidos/${pedidoId}/estado`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
      body: JSON.stringify({ estado: 'anulado' })
    });
    if (!res.ok) {
      const errorText = await res.text();
      throw new Error(`Error ${res.status}: ${errorText}`);
    }
    await loadPedidos();
  } catch (e) {
    alert(`Error anulando pedido: ${e.message}`);
  }
}
</script>
