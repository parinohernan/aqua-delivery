---
import Layout from '../layouts/Layout.astro';
import PedidosSection from '../components/PedidosSection.astro';
import ClientesSection from '../components/ClientesSection.astro';
import ProductosSection from '../components/ProductosSection.astro';
import InformesSection from '../components/InformesSection.astro';
---

<Layout title="Aqua Delivery Manager">
  <!-- Pantalla de carga -->
  <div id="loading" class="loading-screen">
    <div class="spinner"></div>
    <p>Cargando aplicaci√≥n...</p>
  </div>

  <!-- Aplicaci√≥n principal -->
  <div id="mainApp" class="hidden">
    <div class="app-container">
      <!-- Header con gradiente -->
      <header class="header">
        <div class="header-content">
          <div class="header-left">
            <div class="app-icon">
              <img src="/drop.png" alt="Aqua Logo" style="width: 50%; height: 50%; object-fit: contain;" />
            </div>
            <div class="app-title-container">
              <h1 class="app-title">Aqua314</h1>
              <span class="app-subtitle">Delivery Manager</span>      
            </div>
          </div>
          <div class="header-right">
            <span id="userInfo" class="user-info"></span>
            <button id="logoutBtn" onclick="logout()" class="logout-button">
              <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path d="M10 12.5a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v2a.5.5 0 0 0 1 0v-2A1.5 1.5 0 0 0 9.5 2h-8A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-2a.5.5 0 0 0-1 0v2z"/>
                <path d="M15.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708.708L14.293 7.5H5.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3z"/>
              </svg>
              Salir
            </button>
          </div>
        </div>
      </header>

      <!-- Navegaci√≥n Desktop -->
      <nav class="nav-buttons">
        <button data-route="pedidos" class="nav-button">
          <div class="nav-icon">üì¶</div>
          <span>Pedidos</span>
        </button>
        <button data-route="clientes" class="nav-button active">
          <div class="nav-icon">üë•</div>
          <span>Clientes</span>
        </button>
        <button data-route="productos" class="nav-button">
          <div class="nav-icon">üõçÔ∏è</div>
          <span>Productos</span>
        </button>
        <button data-route="informes" class="nav-button">
          <div class="nav-icon">üìä</div>
          <span>Informes</span>
        </button>
      </nav>

      <!-- Contenido principal -->
      <main class="main-content">
        <div id="contentArea" class="content-card">
          <!-- Componentes importados -->
          <PedidosSection />
          <ClientesSection />
          <ProductosSection />
          <InformesSection />
        </div>
      </main>

      <!-- Navegaci√≥n M√≥vil -->
      <nav class="mobile-nav">
        <button data-route="pedidos" class="mobile-nav-button">
          <div class="mobile-nav-icon">üì¶</div>
          <span>Pedidos</span>
        </button>
        <button data-route="clientes" class="mobile-nav-button active">
          <div class="mobile-nav-icon">üë•</div>
          <span>Clientes</span>
        </button>
        <button data-route="productos" class="mobile-nav-button">
          <div class="mobile-nav-icon">üõçÔ∏è</div>
          <span>Productos</span>
        </button>
        <button data-route="informes" class="mobile-nav-button">
          <div class="mobile-nav-icon">üìä</div>
          <span>Informes</span>
        </button>
      </nav>
    </div>

    <!-- Modal de confirmaci√≥n de logout -->
    <div id="logoutModal" class="logout-modal hidden">
      <div class="logout-modal-overlay"></div>
      <div class="logout-modal-content">
        <div class="logout-modal-icon">üö™</div>
        <h3 class="logout-modal-title">¬øCerrar sesi√≥n?</h3>
        <p class="logout-modal-text">¬øEst√°s seguro que deseas salir de la aplicaci√≥n?</p>
        <div class="logout-modal-actions">
          <button id="cancelLogout" class="logout-btn logout-btn-cancel">
            Cancelar
          </button>
          <button id="confirmLogout" class="logout-btn logout-btn-confirm">
            Salir
          </button>
        </div>
      </div>
    </div>

    <!-- Modal de Mapa de Entregas -->
    <div id="deliveryMapModal" class="modal-overlay hidden">
      <div class="modal-content" style="max-width: 90vw; max-height: 90vh; width: 1200px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
          <h4 class="modal-title">üó∫Ô∏è Mapa de Entregas</h4>
          <button onclick="window.closeDeliveryMap()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6b7280;">
            √ó
          </button>
        </div>
        
        <div id="deliveryMapContainer" style="height: 70vh; min-height: 400px; border-radius: 12px; overflow: hidden; border: 2px solid #e5e7eb;"></div>
        
        <div style="margin-top: 1rem; padding: 1rem; background: #f9fafb; border-radius: 8px;">
          <div style="display: flex; gap: 1.5rem; flex-wrap: wrap; justify-content: center;">
            <div style="display: flex; align-items: center; gap: 0.5rem;">
              <div style="width: 12px; height: 12px; background: #ef4444; border-radius: 50%;"></div>
              <span style="font-size: 0.875rem; color: #374151;">Pendientes</span>
            </div>
            <div style="display: flex; align-items: center; gap: 0.5rem;">
              <div style="width: 12px; height: 12px; background: #10b981; border-radius: 50%;"></div>
              <span style="font-size: 0.875rem; color: #374151;">Tu ubicaci√≥n</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</Layout>

<script>
// Estado global
let currentUser: User | null = null;
let currentRoute = 'clientes';

// Inicializaci√≥n
document.addEventListener('DOMContentLoaded', async () => {
  console.log('üöÄ Inicializando aplicaci√≥n...');
  await checkAuth();
  
  // Configurar bot√≥n de logout
  const logoutBtn = document.getElementById('logoutBtn');
  if (logoutBtn) {
    logoutBtn.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      console.log('üñ±Ô∏è Click en bot√≥n logout detectado');
      window.showLogoutModal();
    });
    console.log('‚úÖ Event listener de logout configurado');
  }

  // Configurar modal de logout
  const cancelLogoutBtn = document.getElementById('cancelLogout');
  const confirmLogoutBtn = document.getElementById('confirmLogout');
  const logoutModal = document.getElementById('logoutModal');
  const logoutOverlay = logoutModal?.querySelector('.logout-modal-overlay');

  if (cancelLogoutBtn) {
    cancelLogoutBtn.addEventListener('click', () => {
      console.log('‚ùå Logout cancelado');
      window.hideLogoutModal();
    });
  }

  if (confirmLogoutBtn) {
    confirmLogoutBtn.addEventListener('click', () => {
      console.log('‚úÖ Logout confirmado');
      window.hideLogoutModal();
      window.performLogout();
    });
  }

  if (logoutOverlay) {
    logoutOverlay.addEventListener('click', () => {
      console.log('‚ùå Logout cancelado (click en overlay)');
      window.hideLogoutModal();
    });
  }
  
  // Navegaci√≥n inicial
  const route = localStorage.getItem('lastRoute') || 'clientes';
  navigateTo(route);
});

// Funciones del modal de logout
window.showLogoutModal = function() {
  console.log('üìã Mostrando modal de logout');
  const modal = document.getElementById('logoutModal');
  if (modal) {
    modal.classList.remove('hidden');
    // Peque√±o delay para la animaci√≥n
    setTimeout(() => {
      modal.classList.add('show');
    }, 10);
  }
};

window.hideLogoutModal = function() {
  console.log('üìã Ocultando modal de logout');
  const modal = document.getElementById('logoutModal');
  if (modal) {
    modal.classList.remove('show');
    setTimeout(() => {
      modal.classList.add('hidden');
    }, 300);
  }
};

window.performLogout = function() {
  console.log('üö™ Ejecutando logout...');
  try {
    localStorage.removeItem('token');
    localStorage.removeItem('user');
    localStorage.removeItem('lastRoute');
    console.log('üóëÔ∏è LocalStorage limpiado');
    console.log('üîÑ Redirigiendo a login...');
    window.location.href = '/login';
  } catch (error: unknown) {
    console.error('‚ùå Error en logout:', error);
    localStorage.clear();
    window.location.href = '/login';
  }
};

// Mantener compatibilidad con llamadas directas
window.logout = function() {
  window.showLogoutModal();
};

// Autenticaci√≥n
async function checkAuth() {
  const token = localStorage.getItem('token');
  const userStr = localStorage.getItem('user');

  if (!token || !userStr) {
    redirectToLogin();
    return;
  }

  try {
    currentUser = JSON.parse(userStr) as User;
    showMainApp();
    
    // Mostrar info usuario
    const userInfo = document.getElementById('userInfo');
    if (userInfo && currentUser) {
      userInfo.textContent = `Hola, ${currentUser.nombre || currentUser.telegramId}`;
    }
  } catch (e) {
    redirectToLogin();
  }
}

function redirectToLogin() {
  window.location.href = '/login';
}

function showMainApp() {
  document.getElementById('loading')?.classList.add('hidden');
  document.getElementById('mainApp')?.classList.remove('hidden');
}

// Mapa de Entregas
let deliveryMap: any = null;
let deliveryMarkers: any[] = [];

window.showDeliveryMap = async function() {
  console.log('üó∫Ô∏è Mostrando mapa de entregas...');
  
  const modal = document.getElementById('deliveryMapModal');
  if (!modal) {
    console.error('‚ùå Modal de mapa no encontrado');
    return;
  }
  
  modal.classList.remove('hidden');
  modal.classList.add('show');
  
  // Esperar a que el modal sea visible
  setTimeout(async () => {
    await initDeliveryMap();
  }, 100);
};

window.closeDeliveryMap = function() {
  console.log('üó∫Ô∏è Cerrando mapa de entregas...');
  
  const modal = document.getElementById('deliveryMapModal');
  if (modal) {
    modal.classList.remove('show');
    modal.classList.add('hidden');
  }
  
  // Limpiar mapa
  if (deliveryMap) {
    deliveryMap.remove();
    deliveryMap = null;
    deliveryMarkers = [];
  }
};

async function initDeliveryMap() {
  const container = document.getElementById('deliveryMapContainer');
  if (!container) {
    console.error('‚ùå Contenedor de mapa no encontrado');
    return;
  }
  
  // Limpiar mapa anterior si existe
  if (deliveryMap) {
    deliveryMap.remove();
    deliveryMap = null;
  }
  
  // Limpiar contenedor
  container.innerHTML = '';
  
  try {
    // Obtener pedidos pendientes
    const pedidos = window.currentPedidos || window.allPedidos || [];
    const pedidosPendientes = pedidos.filter(p => p.estado === 'pendient' && p.latitud && p.longitud);
    
    console.log('üìç Pedidos con ubicaci√≥n:', pedidosPendientes.length);
    
    if (pedidosPendientes.length === 0) {
      container.innerHTML = `
        <div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #f9fafb;">
          <div style="text-align: center; padding: 2rem;">
            <div style="font-size: 3rem; margin-bottom: 1rem;">üìç</div>
            <h4 style="color: #374151; margin: 0 0 0.5rem 0;">No hay entregas pendientes</h4>
            <p style="color: #6b7280; margin: 0;">No se encontraron pedidos pendientes con ubicaci√≥n</p>
          </div>
        </div>
      `;
      return;
    }
    
    // Calcular centro del mapa
    const latitudes = pedidosPendientes.map(p => parseFloat(p.latitud));
    const longitudes = pedidosPendientes.map(p => parseFloat(p.longitud));
    const centerLat = latitudes.reduce((a, b) => a + b, 0) / latitudes.length;
    const centerLng = longitudes.reduce((a, b) => a + b, 0) / longitudes.length;
    
    // Crear mapa
    deliveryMap = await initMapPWA('deliveryMapContainer', {
      center: [centerLat, centerLng],
      zoom: 13
    });
    
    if (!deliveryMap) {
      console.error('‚ùå No se pudo inicializar el mapa');
      return;
    }
    
    // Agregar marcador de ubicaci√≥n actual
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition((position) => {
        const currentIcon = L.divIcon({
          className: 'current-location-marker',
          html: '<div style="background: #10b981; width: 16px; height: 16px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 8px rgba(0,0,0,0.3);"></div>',
          iconSize: [22, 22],
          iconAnchor: [11, 11]
        });
        
        L.marker([position.coords.latitude, position.coords.longitude], { icon: currentIcon })
          .addTo(deliveryMap)
          .bindPopup('üìç Tu ubicaci√≥n actual');
      });
    }
    
    // Agregar marcadores de pedidos
    pedidosPendientes.forEach(pedido => {
      const lat = parseFloat(pedido.latitud);
      const lng = parseFloat(pedido.longitud);
      
      const pedidoIcon = L.divIcon({
        className: 'delivery-marker',
        html: '<div style="background: #ef4444; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 8px rgba(0,0,0,0.4);"></div>',
        iconSize: [26, 26],
        iconAnchor: [13, 13]
      });
      
      const nombreCliente = pedido.cliente_nombre || `${pedido.nombre || ''} ${pedido.apellido || ''}`.trim();
      const direccion = pedido.direccion || 'Sin direcci√≥n';
      
      const marker = L.marker([lat, lng], { icon: pedidoIcon })
        .addTo(deliveryMap)
        .bindPopup(`
          <div style="min-width: 200px;">
            <strong style="font-size: 1.1rem;">Pedido #${pedido.codigo || pedido.id}</strong><br>
            <strong>Cliente:</strong> ${nombreCliente}<br>
            <strong>Direcci√≥n:</strong> ${direccion}<br>
            <button onclick="window.closeDeliveryMap(); window.startDelivery(${pedido.codigo || pedido.id})" 
                    style="margin-top: 0.5rem; padding: 0.5rem 1rem; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; width: 100%;">
              üöö Iniciar Entrega
            </button>
          </div>
        `);
      
      deliveryMarkers.push(marker);
    });
    
    // Ajustar vista para mostrar todos los marcadores
    if (deliveryMarkers.length > 0) {
      const group = L.featureGroup(deliveryMarkers);
      deliveryMap.fitBounds(group.getBounds().pad(0.1));
    }
    
    // Invalidar tama√±o del mapa
    setTimeout(() => {
      if (deliveryMap) {
        deliveryMap.invalidateSize();
      }
    }, 100);
    
  } catch (error: unknown) {
    console.error('‚ùå Error inicializando mapa:', error);
    const errorMessage = error instanceof Error ? error.message : 'Error desconocido';
    container.innerHTML = `
      <div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #fef2f2;">
        <div style="text-align: center; padding: 2rem;">
          <div style="font-size: 3rem; margin-bottom: 1rem;">‚ö†Ô∏è</div>
          <h4 style="color: #dc2626; margin: 0 0 0.5rem 0;">Error cargando mapa</h4>
          <p style="color: #991b1b; margin: 0;">${errorMessage}</p>
        </div>
      </div>
    `;
  }
}


// Navegaci√≥n
document.addEventListener('click', (e) => {
  const target = e.target as HTMLElement | null;
  if (target && (target.matches?.('[data-route]') || target.closest?.('[data-route]'))) {
    const button = target.matches?.('[data-route]') ? target : target.closest?.('[data-route]') as HTMLElement | null;
    if (button) {
      const route = button.getAttribute('data-route');
      if (route) navigateTo(route);
    }
  }
});

function navigateTo(route) {
  currentRoute = route;
  localStorage.setItem('lastRoute', route);
  
  // Actualizar botones
  document.querySelectorAll('.nav-button, .mobile-nav-button').forEach(btn => {
    btn.classList.toggle('active', btn.getAttribute('data-route') === route);
  });
  
  // Ocultar todas las secciones
  document.querySelectorAll('.section-content').forEach(el => {
    if (el instanceof HTMLElement && el.style) {
      el.style.display = 'none';
    }
  });
  
  // Mostrar secci√≥n actual e inicializarla
  const sectionId = `${route}Section`;
  const sectionEl = document.getElementById(sectionId);
  
  if (sectionEl && sectionEl instanceof HTMLElement && sectionEl.style) {
    sectionEl.style.display = 'block';
    
    // Inicializar l√≥gica espec√≠fica de la secci√≥n
    if (route === 'pedidos' && window.initPedidosSection) window.initPedidosSection();
    if (route === 'clientes' && window.initClientesSection) window.initClientesSection();
    if (route === 'productos' && window.initProductosSection) window.initProductosSection();
    if (route === 'informes' && window.initInformesSection) window.initInformesSection();
  }
}
</script>
